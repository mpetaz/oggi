<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Betting Engine - SISTEMA FUNZIONANTE</title>
    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-700: #374151;
            --purple: #8b5cf6; --orange: #f97316;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: var(--gray-700); line-height: 1.6; min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }
        .card { 
            background: white; border: 1px solid var(--gray-200); border-radius: 16px; 
            padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.5rem;
        }
        .card.mpetaz { border-left: 5px solid var(--purple); }
        .card.gemini { border-left: 5px solid var(--orange); }
        .card.success { background: linear-gradient(135deg, var(--success), #059669); color: white; border: none; }
        .card.danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; border: none; }

        .btn { 
            display: inline-flex; align-items: center; justify-content: center; 
            padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; 
            font-size: 0.875rem; transition: all 0.3s ease; cursor: pointer; 
            border: none; text-decoration: none; text-align: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .btn-success { background: var(--success); color: white; }
        .btn-mpetaz { background: var(--purple); color: white; }
        .btn-gemini { background: var(--orange); color: white; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }

        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .loader { 
            width: 40px; height: 40px; margin: 20px auto; border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input[type="file"] { display: none; }
        input[type="date"], input[type="text"], select, textarea {
            width: 100%; padding: 0.875rem; border: 2px solid var(--gray-200); 
            border-radius: 10px; font-size: 0.875rem; background: white; transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .file-label { 
            cursor: pointer; padding: 1.25rem; border: 3px dashed var(--gray-200); 
            border-radius: 12px; text-align: center; transition: all 0.3s ease; 
            display: block; background: var(--gray-50);
        }
        .file-label:hover { 
            border-color: var(--primary); background: #eff6ff; transform: translateY(-2px);
        }

        .nav { 
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; 
            padding: 1.5rem 0; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .nav h1 { font-size: 1.75rem; font-weight: 800; }

        .text-center { text-align: center; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-purple { color: var(--purple); }
        .text-orange { color: var(--orange); }
        .text-gray { color: #6b7280; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }

        .notification {
            position: fixed; top: 2rem; right: 2rem; z-index: 1000;
            padding: 1.25rem 1.75rem; border-radius: 12px; max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .notification.error { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .notification.warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }

        .debug-section {
            background: #1a202c; color: #e2e8f0; border-radius: 12px; padding: 1.25rem; 
            font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem; 
            max-height: 400px; overflow-y: auto; margin-top: 1rem;
        }

        .status-indicator {
            display: inline-block; width: 14px; height: 14px; border-radius: 50%;
            margin-right: 10px; vertical-align: middle;
        }
        .status-success { background: var(--success); box-shadow: 0 0 12px rgba(16, 185, 129, 0.4); }
        .status-error { background: var(--danger); box-shadow: 0 0 12px rgba(239, 68, 68, 0.4); }
        .status-connecting { background: var(--primary); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .prediction-item { 
            border-left: 5px solid var(--primary); padding: 1.25rem; margin-bottom: 1rem;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px;
        }
        .prediction-item.mpetaz { border-left-color: var(--purple); }
        .prediction-item.gemini { border-left-color: var(--orange); }

        .stats-comparison {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;
        }

        .learning-badge {
            display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;
        }
        .learning-badge.improving { background: #dcfce7; color: #166534; }
        .learning-badge.declining { background: #fef2f2; color: #dc2626; }
        .learning-badge.stable { background: #f3f4f6; color: #6b7280; }

        .roi-display {
            font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;
        }
        .roi-positive { color: var(--success); }
        .roi-negative { color: var(--danger); }

        .odds-badge {
            display: inline-block; padding: 0.25rem 0.5rem; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;
            background: #dcfce7; color: #166534;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .stats-comparison { grid-template-columns: 1fr; }
            .container { padding: 0 0.75rem; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="container">
            <h1>ü§ñ AI Betting Engine - SISTEMA FUNZIONANTE</h1>
            <p style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem;">
                üî• Sistema ripristinato alla versione funzionante
            </p>
        </div>
    </nav>

    <div class="container">
        <!-- Sistema Status -->
        <div class="card" id="system-status-card">
            <h2 class="font-bold mb-4">üîå Sistema Firebase</h2>
            <div id="firebase-status" class="mb-4">
                <span class="status-indicator status-connecting"></span>
                <span>Inizializzazione...</span>
            </div>
        </div>

        <!-- Upload Area -->
        <section class="card">
            <h2 class="font-bold mb-6">üìÖ Caricamento Dati</h2>
            <div class="grid grid-3">
                <div>
                    <label for="prediction-date" class="font-medium mb-2 block">Data Analisi</label>
                    <input type="date" id="prediction-date">
                </div>
                <div>
                    <label for="today-file" class="file-label" id="today-label">
                        <span class="font-medium">üìã Partite da Analizzare</span>
                        <p class="text-sm text-gray mt-2">CSV partite giornaliere</p>
                    </label>
                    <input type="file" id="today-file" accept=".csv" />
                </div>
                <div>
                    <label for="results-file" class="file-label" id="results-label">
                        <span class="font-medium">üèÜ File Risultati</span>
                        <p class="text-sm text-gray mt-2">CSV per verifica</p>
                    </label>
                    <input type="file" id="results-file" accept=".csv" />
                </div>
            </div>
        </section>

        <!-- Strategie -->
        <section>
            <div class="grid grid-2">
                <div class="card mpetaz">
                    <h3 class="font-bold mb-4">üü£ Strategia Mpetaz</h3>
                    <label for="mpetaz-historical" class="file-label mb-4" id="mpetaz-label">
                        <span class="font-medium">üìä Dati Storici Mpetaz</span>
                    </label>
                    <input type="file" id="mpetaz-historical" accept=".csv" />
                    <button id="analyze-mpetaz" class="btn btn-mpetaz" style="width: 100%; margin-top: 1rem;" disabled onclick="runAnalysis('mpetaz')">
                        üöÄ Analizza con Mpetaz
                    </button>
                    <div id="mpetaz-results" class="mt-4"></div>
                </div>

                <div class="card gemini">
                    <h3 class="font-bold mb-4">üü† Strategia Gemini</h3>
                    <label for="gemini-historical" class="file-label mb-4" id="gemini-label">
                        <span class="font-medium">üìä Dati Storici Gemini</span>
                    </label>
                    <input type="file" id="gemini-historical" accept=".csv" />
                    <button id="analyze-gemini" class="btn btn-gemini" style="width: 100%; margin-top: 1rem;" disabled onclick="runAnalysis('gemini')">
                        üöÄ Analizza con Gemini
                    </button>
                    <div id="gemini-results" class="mt-4"></div>
                </div>
            </div>
        </section>

        <!-- Verifica Risultati -->
        <div class="card">
            <h2 class="font-bold mb-4">‚úÖ Verifica e Apprendimento</h2>
            <div class="grid grid-2">
                <button class="btn btn-success" onclick="verifyResults()">
                    ‚úÖ Verifica Risultati
                </button>
                <button class="btn btn-primary" onclick="updateLearningModel()">
                    üß† Aggiorna Modello AI
                </button>
            </div>
            <div id="verification-summary" class="mt-4"></div>
        </div>

        <!-- STATISTICHE -->
        <section class="card">
            <h2 class="font-bold mb-6">üìä Confronto Prestazioni</h2>

            <div class="stats-comparison">
                <!-- Mpetaz Stats -->
                <div class="card mpetaz">
                    <h3 class="font-bold mb-4 text-purple">üü£ Mpetaz Performance</h3>
                    <div class="grid grid-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-2" id="mpetaz-total">0</div>
                            <div class="text-sm text-gray">Totali</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue mb-2" id="mpetaz-pending">0</div>
                            <div class="text-sm text-gray">In Attesa</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green mb-2" id="mpetaz-won">0</div>
                            <div class="text-sm text-gray">Vinti</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-red mb-2" id="mpetaz-lost">0</div>
                            <div class="text-sm text-gray">Persi</div>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="text-2xl font-bold text-purple mb-2" id="mpetaz-winrate">--%</div>
                        <div class="text-sm text-gray">Win Rate</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray mb-1">ROI</div>
                        <div class="roi-display" id="mpetaz-roi">--%</div>
                    </div>
                    <div class="text-center mt-3">
                        <span id="mpetaz-trend" class="learning-badge stable">-</span>
                    </div>
                </div>

                <!-- Gemini Stats -->
                <div class="card gemini">
                    <h3 class="font-bold mb-4 text-orange">üü† Gemini Performance</h3>
                    <div class="grid grid-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-2" id="gemini-total">0</div>
                            <div class="text-sm text-gray">Totali</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue mb-2" id="gemini-pending">0</div>
                            <div class="text-sm text-gray">In Attesa</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green mb-2" id="gemini-won">0</div>
                            <div class="text-sm text-gray">Vinti</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-red mb-2" id="gemini-lost">0</div>
                            <div class="text-sm text-gray">Persi</div>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="text-2xl font-bold text-orange mb-2" id="gemini-winrate">--%</div>
                        <div class="text-sm text-gray">Win Rate</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray mb-1">ROI</div>
                        <div class="roi-display" id="gemini-roi">--%</div>
                    </div>
                    <div class="text-center mt-3">
                        <span id="gemini-trend" class="learning-badge stable">-</span>
                    </div>
                </div>
            </div>

            <!-- Winner Indicator -->
            <div class="text-center mt-6 p-4 rounded-lg" id="winner-indicator" style="background: #f3f4f6; display: none;">
                <h3 class="font-bold mb-2">üèÜ Strategia Vincente</h3>
                <div id="winner-text" class="text-lg"></div>
            </div>
        </section>

        <!-- Console Debug -->
        <div class="card">
            <h2 class="font-bold mb-4">üîç Console Sistema</h2>
            <div class="debug-section" id="debug-console">
                <div style="color: #10b981;">[SISTEMA] Versione funzionante ripristinata</div>
            </div>
            <div class="mt-4 grid grid-2 gap-3">
                <button class="btn btn-secondary" onclick="clearConsole()">üóëÔ∏è Pulisci</button>
                <button class="btn btn-secondary" onclick="exportData()">üìä Esporta Dati</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT FUNZIONANTE -->
    <script type="module">
        const MIN_ODDS = 1.20;

        let firebaseApp = null, db = null, auth = null, currentUser = null, firebaseReady = false;
        let firestoreCollection, firestoreAddDoc, firestoreGetDocs, firestoreQuery, firestoreWhere, firestoreDoc, firestoreUpdateDoc, firestoreDeleteDoc;

        let todayMatches = { data: [], name: '' };
        let mpetazHistory = { data: [], name: '' };
        let geminiHistory = { data: [], name: '' };
        let resultsData = { data: [], name: '' };

        const log = (level, message, data = null) => {
            const timestamp = new Date().toLocaleTimeString();
            const colors = { 'error': '#ef4444', 'warn': '#f59e0b', 'info': '#3b82f6', 'success': '#10b981' };

            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, data || '');

            const console_el = document.getElementById('debug-console');
            if (console_el) {
                const logDiv = document.createElement('div');
                logDiv.style.color = colors[level.toLowerCase()] || '#e2e8f0';
                logDiv.innerHTML = `[${timestamp}] <strong>${level.toUpperCase()}:</strong> ${message}`;
                console_el.appendChild(logDiv);

                while (console_el.children.length > 30) {
                    console_el.removeChild(console_el.firstChild);
                }
                console_el.scrollTop = console_el.scrollHeight;
            }
        };

        const notify = (message, type = 'success') => {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<p>${message}</p>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
            log('notification', message);
        };

        async function initFirebase() {
            try {
                log('info', 'üöÄ Inizializzazione Firebase...');

                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js');
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js');
                const authModule = await import('https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js');

                firestoreCollection = firestoreModule.collection;
                firestoreAddDoc = firestoreModule.addDoc;
                firestoreGetDocs = firestoreModule.getDocs;
                firestoreQuery = firestoreModule.query;
                firestoreWhere = firestoreModule.where;
                firestoreDoc = firestoreModule.doc;
                firestoreUpdateDoc = firestoreModule.updateDoc;
                firestoreDeleteDoc = firestoreModule.deleteDoc;

                const { getFirestore, enableNetwork } = firestoreModule;
                const { getAuth, signInAnonymously, onAuthStateChanged } = authModule;

                const firebaseConfig = {
                    apiKey: "AIzaSyDohOjXix2tRoEhm8vv1gCYrqXlNeXjbGM",
                    authDomain: "oggi-17f48.firebaseapp.com",
                    projectId: "oggi-17f48",
                    storageBucket: "oggi-17f48.firebasestorage.app",
                    messagingSenderId: "961828441770",
                    appId: "1:961828441770:web:270382ebd68fb953ff8ad3"
                };

                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                await enableNetwork(db);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        log('success', `‚úÖ Sistema autenticato: ${user.uid}`);
                        document.getElementById('firebase-status').innerHTML = '<span class="status-indicator status-success"></span><span>üü¢ Sistema Operativo</span>';
                        firebaseReady = true;
                        loadStatistics();
                    } else {
                        signInAnonymously(auth).catch(error => log('error', `‚ùå Errore auth: ${error.message}`));
                    }
                });

                log('success', 'üéâ Firebase inizializzato!');

            } catch (error) {
                log('error', `‚ùå Errore Firebase: ${error.message}`, error);
                document.getElementById('firebase-status').innerHTML = '<span class="status-indicator status-error"></span><span>‚ùå Errore Sistema</span>';
            }
        }

        const parseCSV = (csvText, filename) => {
            try {
                log('info', `üìÑ Parsing ${filename}...`);

                const cleanText = csvText.replace(/^\ufeff/, '').trim();
                const lines = cleanText.split(/\r?\n/).filter(line => line.trim());

                if (lines.length < 2) throw new Error('CSV non valido');

                const normalizeField = (field) => {
                    const cleaned = field.replace(/['"\s]/g, '').toLowerCase();
                    const fieldMap = {
                        'lega': 'Lega', 'league': 'Lega',
                        'partita': 'Partita', 'match': 'Partita',
                        'risultato': 'Risultato', 'result': 'Risultato',
                        'probabilita': 'Probabilit√†', 'probabilit√†': 'Probabilit√†', 'probability': 'Probabilit√†',
                        'mercato': 'Mercato', 'market': 'Mercato',
                        'tip': 'Tip',
                        'quota': 'Quota', 'odds': 'Quota',
                        'esito': 'esito', 'outcome': 'esito', 'vinto/perso': 'esito',
                        'data': 'data', 'date': 'data'
                    };
                    return fieldMap[cleaned] || field;
                };

                const header = lines[0].split(',').map(h => normalizeField(h.trim()));

                const data = lines.slice(1).map(line => {
                    if (!line.trim()) return null;

                    const values = [];
                    let currentValue = '', inQuotes = false;

                    for (let char of line) {
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) {
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            currentValue = '';
                        } else currentValue += char;
                    }
                    values.push(currentValue.trim().replace(/^"|"$/g, ''));

                    const entry = {};
                    header.forEach((col, i) => {
                        if (col && i < values.length) {
                            let value = values[i];

                            if (col === 'Quota') value = value.replace(',', '.');
                            else if (col === 'Probabilit√†') value = value.replace('%', '');
                            else if (col === 'esito') {
                                const lower = value.toLowerCase().trim();
                                if (lower === 'vinto' || lower === 'win') value = 'Vinto';
                                else if (lower === 'perso' || lower === 'lost') value = 'Perso';
                            }

                            entry[col] = value;
                        }
                    });

                    return entry;
                }).filter(Boolean);

                log('success', `‚úÖ ${filename}: ${data.length} righe processate`);
                return data;

            } catch (error) {
                log('error', `‚ùå Errore parsing ${filename}:`, error);
                throw error;
            }
        };

        const handleUpload = (event, dataType, labelElement) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = parseCSV(e.target.result, file.name);

                    switch(dataType) {
                        case 'today':
                            todayMatches = { data, name: file.name };
                            document.getElementById('analyze-mpetaz').disabled = false;
                            document.getElementById('analyze-gemini').disabled = false;
                            break;
                        case 'mpetazHistory':
                            mpetazHistory = { data, name: file.name };
                            break;
                        case 'geminiHistory':
                            geminiHistory = { data, name: file.name };
                            break;
                        case 'results':
                            resultsData = { data, name: file.name };
                            break;
                    }

                    labelElement.querySelector('span').textContent = file.name;
                    notify(`${file.name} caricato (${data.length} righe)`);

                } catch (error) {
                    log('error', `‚ùå Errore file ${file.name}:`, error);
                    notify(`Errore: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        };

        const runAnalysis = async (strategy) => {
            if (!firebaseReady) {
                notify('Sistema non pronto', 'warning');
                return;
            }

            const historyData = strategy === 'mpetaz' ? mpetazHistory : geminiHistory;
            const resultsElement = document.getElementById(`${strategy}-results`);

            if (!todayMatches.data.length) {
                notify('Carica le partite da analizzare', 'error');
                return;
            }
            if (!historyData.data.length) {
                notify(`Carica dati storici ${strategy}`, 'error');
                return;
            }

            log('info', `üöÄ Analisi ${strategy} avviata...`);
            resultsElement.innerHTML = '<div class="loader"></div>';

            setTimeout(async () => {
                try {
                    const stats = calculateHistoricalStats(historyData.data);

                    const validMatches = todayMatches.data.filter(match => {
                        const quota = parseFloat(String(match.Quota || '0').replace(',', '.'));
                        const prob = parseFloat(String(match.Probabilit√† || '0').replace('%', ''));

                        return !isNaN(quota) && 
                               quota >= MIN_ODDS && 
                               quota <= 3.0 && 
                               prob >= 70 && 
                               match.Lega && match.Partita && match.Tip &&
                               !match.Lega.toLowerCase().includes('cup');
                    });

                    const scoredMatches = validMatches.map(match => {
                        let score = 0;

                        const quota = parseFloat(match.Quota.replace(',', '.'));
                        const prob = parseFloat(match.Probabilit√†.replace('%', ''));

                        score += Math.min(prob * 0.7, 55);

                        if (stats.league[match.Lega]?.total >= 3) {
                            score += stats.league[match.Lega].rate * 40;
                        }

                        if (stats.tip[match.Tip]?.total >= 5) {
                            score += stats.tip[match.Tip].rate * 35;
                        }

                        if (quota >= MIN_ODDS && quota <= 1.4) {
                            score += 20;
                        } else if (quota <= 1.7) {
                            score += 15;
                        } else if (quota <= 2.2) {
                            score += 10;
                        }

                        return { 
                            ...match, 
                            score: Math.round(score * 100) / 100,
                            strategy: strategy
                        };
                    }).sort((a, b) => b.score - a.score);

                    const top10 = scoredMatches.slice(0, 10);

                    let html = `<h5 class="font-medium mb-3">üèÜ Top 10 ${strategy.toUpperCase()}:</h5>`;
                    if (top10.length === 0) {
                        html += '<p class="text-red">Nessuna partita trovata con odds ‚â• 1.20 e criteri richiesti</p>';
                    } else {
                        top10.forEach((match, i) => {
                            const quota = parseFloat(match.Quota.replace(',', '.'));
                            html += `
                                <div class="prediction-item ${strategy}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                                #${i + 1} ${match.Partita}
                                                <span class="odds-badge">@${quota.toFixed(2)}</span>
                                            </div>
                                            <div style="font-size: 0.875rem; color: #6b7280;">
                                                ${match.Lega} ‚Ä¢ ${match.Mercato} ${match.Tip}
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding-left: 1rem;">
                                            <div style="font-size: 1.25rem; font-weight: bold; color: ${strategy === 'mpetaz' ? '#8b5cf6' : '#f97316'};">
                                                ${match.score}
                                            </div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">Score</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    resultsElement.innerHTML = html;

                    if (top10.length > 0) {
                        await savePredictions(top10, strategy);
                    }

                    log('success', `‚úÖ Analisi ${strategy}: ${top10.length} pronostici generati`);
                    notify(`${strategy}: ${top10.length} pronostici salvati!`);

                } catch (error) {
                    resultsElement.innerHTML = '<p style="color: #ef4444;">Errore analisi</p>';
                    log('error', `‚ùå Errore analisi ${strategy}:`, error);
                    notify(`Errore ${strategy}: ${error.message}`, 'error');
                }
            }, 200);
        };

        const calculateHistoricalStats = (data) => {
            const stats = { league: {}, tip: {}, market: {}, global: { won: 0, total: 0 } };

            data.forEach(row => {
                const lega = row.Lega;
                const tip = row.Tip;
                const esito = row.esito;
                const quota = parseFloat(String(row.Quota || '0').replace(',', '.'));

                if (!esito || !lega || !tip || isNaN(quota) || quota < MIN_ODDS) return;
                if (lega.toLowerCase().includes('cup')) return;

                const won = esito.toLowerCase() === 'vinto' ? 1 : 0;

                if (!stats.league[lega]) stats.league[lega] = { won: 0, total: 0, rate: 0 };
                stats.league[lega].total++;
                stats.league[lega].won += won;
                stats.league[lega].rate = stats.league[lega].won / stats.league[lega].total;

                if (!stats.tip[tip]) stats.tip[tip] = { won: 0, total: 0, rate: 0 };
                stats.tip[tip].total++;
                stats.tip[tip].won += won;
                stats.tip[tip].rate = stats.tip[tip].won / stats.tip[tip].total;

                stats.global.total++;
                stats.global.won += won;
            });

            return stats;
        };

        const savePredictions = async (predictions, strategy) => {
            if (!firebaseReady) return;

            try {
                log('info', `üíæ Salvataggio ${predictions.length} pronostici ${strategy}...`);

                const collection = firestoreCollection(db, "ai_predictions");
                const date = document.getElementById('prediction-date').value;

                for (const prediction of predictions) {
                    const quota = parseFloat(prediction.Quota.replace(',', '.'));

                    const doc = {
                        date: date,
                        strategy: strategy,
                        match: prediction.Partita,
                        league: prediction.Lega,
                        market: prediction.Mercato,
                        tip: prediction.Tip,
                        quota: quota,
                        probabilita: parseFloat(prediction.Probabilit√†.replace('%', '')),
                        score: prediction.score,
                        status: 'pending',
                        odds_filter: MIN_ODDS,
                        user_id: currentUser.uid,
                        created_at: new Date().toISOString()
                    };

                    await firestoreAddDoc(collection, doc);
                }

                log('success', `‚úÖ ${predictions.length} pronostici ${strategy} salvati`);
                loadStatistics();

            } catch (error) {
                log('error', `‚ùå Errore salvataggio ${strategy}:`, error);
            }
        };

        const verifyResults = async () => {
            if (!firebaseReady) {
                notify('Sistema non pronto', 'warning');
                return;
            }

            if (!resultsData.data.length) {
                notify('Carica file risultati prima', 'error');
                return;
            }

            log('info', '‚úÖ Verifica risultati avviata...');

            try {
                const snapshot = await firestoreGetDocs(firestoreCollection(db, "ai_predictions"));
                const predictions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const pendingPredictions = predictions.filter(p => p.status === 'pending');

                let verified = 0;

                for (const prediction of pendingPredictions) {
                    const result = resultsData.data.find(r => 
                        matchPredictionWithResult(prediction, r)
                    );

                    if (result && result.esito) {
                        const docRef = firestoreDoc(db, "ai_predictions", prediction.id);
                        const newStatus = result.esito.toLowerCase() === 'vinto' ? 'won' : 'lost';

                        await firestoreUpdateDoc(docRef, {
                            status: newStatus,
                            verified_at: new Date().toISOString(),
                            actual_result: result.Risultato || 'N/A'
                        });

                        verified++;
                        log('success', `‚úÖ ${prediction.match} (@${prediction.quota.toFixed(2)}): ${newStatus}`);
                    }
                }

                loadStatistics();
                document.getElementById('verification-summary').innerHTML = `
                    <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; color: #166534;">
                        <strong>‚úÖ Verifica completata:</strong> ${verified} pronostici aggiornati
                    </div>
                `;

                notify(`${verified} pronostici verificati!`);
                log('success', `‚úÖ Verifica completata: ${verified} risultati`);

            } catch (error) {
                log('error', `‚ùå Errore verifica: ${error.message}`, error);
                notify(`Errore verifica: ${error.message}`, 'error');
            }
        };

        const matchPredictionWithResult = (prediction, result) => {
            const normalize = str => str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();

            const predMatch = normalize(prediction.match);
            const resultMatch = normalize(result.Partita || '');
            const predLeague = normalize(prediction.league);
            const resultLeague = normalize(result.Lega || '');
            const predTip = normalize(prediction.tip);
            const resultTip = normalize(result.Tip || '');

            if (predMatch === resultMatch && predLeague === resultLeague && predTip === resultTip) {
                return true;
            }

            if (predLeague === resultLeague && predTip === resultTip) {
                const predTeams = predMatch.split(' - ').map(t => t.trim()).sort();
                const resultTeams = resultMatch.split(' - ').map(t => t.trim()).sort();

                if (predTeams.length === 2 && resultTeams.length === 2) {
                    const match1 = predTeams[0].substring(0, 5) === resultTeams[0].substring(0, 5);
                    const match2 = predTeams[1].substring(0, 5) === resultTeams[1].substring(0, 5);
                    return match1 && match2;
                }
            }

            return false;
        };

        const loadStatistics = async () => {
            if (!firebaseReady) return;

            try {
                const snapshot = await firestoreGetDocs(firestoreCollection(db, "ai_predictions"));
                const allPredictions = snapshot.docs.map(doc => doc.data());

                const mpetazPreds = allPredictions.filter(p => p.strategy === 'mpetaz');
                const geminiPreds = allPredictions.filter(p => p.strategy === 'gemini');

                const mpetazStats = calculateStrategyStats(mpetazPreds);
                const geminiStats = calculateStrategyStats(geminiPreds);

                updateStrategyDisplay('mpetaz', mpetazStats);
                updateStrategyDisplay('gemini', geminiStats);

                updateWinnerIndicator(mpetazStats, geminiStats);

                log('success', 'üìä Statistiche aggiornate');

            } catch (error) {
                log('error', `‚ùå Errore stats: ${error.message}`);
            }
        };

        const calculateStrategyStats = (predictions) => {
            const total = predictions.length;
            const pending = predictions.filter(p => p.status === 'pending').length;
            const won = predictions.filter(p => p.status === 'won').length;
            const lost = predictions.filter(p => p.status === 'lost').length;
            const verified = won + lost;

            const winRate = verified > 0 ? (won / verified) * 100 : 0;

            let totalStake = 0;
            let totalReturn = 0;

            predictions.filter(p => p.status === 'won' || p.status === 'lost').forEach(pred => {
                totalStake += 1;
                if (pred.status === 'won') {
                    totalReturn += pred.quota || 0;
                }
            });

            const roi = totalStake > 0 ? ((totalReturn - totalStake) / totalStake) * 100 : 0;

            return { total, pending, won, lost, verified, winRate, roi };
        };

        const updateStrategyDisplay = (strategy, stats) => {
            document.getElementById(`${strategy}-total`).textContent = stats.total;
            document.getElementById(`${strategy}-pending`).textContent = stats.pending;
            document.getElementById(`${strategy}-won`).textContent = stats.won;
            document.getElementById(`${strategy}-lost`).textContent = stats.lost;

            const winRateElement = document.getElementById(`${strategy}-winrate`);
            if (stats.verified > 0) {
                winRateElement.textContent = stats.winRate.toFixed(1) + '%';
            } else {
                winRateElement.textContent = '--% (attesa verifica)';
            }

            const roiElement = document.getElementById(`${strategy}-roi`);
            if (stats.verified > 0) {
                roiElement.textContent = (stats.roi > 0 ? '+' : '') + stats.roi.toFixed(2) + '%';
                roiElement.className = `roi-display ${stats.roi > 0 ? 'roi-positive' : 'roi-negative'}`;
            } else {
                roiElement.textContent = '--% (attesa verifica)';
                roiElement.className = 'roi-display';
            }

            const trendElement = document.getElementById(`${strategy}-trend`);
            if (stats.verified >= 5) {
                if (stats.winRate > 60) {
                    trendElement.textContent = 'In Crescita';
                    trendElement.className = 'learning-badge improving';
                } else if (stats.winRate < 45) {
                    trendElement.textContent = 'In Calo';
                    trendElement.className = 'learning-badge declining';
                } else {
                    trendElement.textContent = 'Stabile';
                    trendElement.className = 'learning-badge stable';
                }
            } else {
                trendElement.textContent = 'Dati insufficienti';
                trendElement.className = 'learning-badge stable';
            }
        };

        const updateWinnerIndicator = (mpetazStats, geminiStats) => {
            const indicator = document.getElementById('winner-indicator');
            const text = document.getElementById('winner-text');

            if (mpetazStats.verified === 0 && geminiStats.verified === 0) {
                indicator.style.display = 'none';
                return;
            }

            let winner, color, bgColor;

            if (mpetazStats.verified > 0 && geminiStats.verified > 0) {
                if (mpetazStats.roi > geminiStats.roi) {
                    winner = `Mpetaz vincente (ROI: ${mpetazStats.roi.toFixed(2)}% vs ${geminiStats.roi.toFixed(2)}%)`;
                    color = '#8b5cf6';
                    bgColor = '#f3e8ff';
                } else if (geminiStats.roi > mpetazStats.roi) {
                    winner = `Gemini vincente (ROI: ${geminiStats.roi.toFixed(2)}% vs ${mpetazStats.roi.toFixed(2)}%)`;
                    color = '#f97316';
                    bgColor = '#fff7ed';
                } else {
                    winner = 'Pareggio nelle performance';
                    color = '#6b7280';
                    bgColor = '#f9fafb';
                }
            } else if (mpetazStats.verified > 0) {
                winner = `Solo Mpetaz verificato (ROI: ${mpetazStats.roi.toFixed(2)}%)`;
                color = '#8b5cf6';
                bgColor = '#f3e8ff';
            } else {
                winner = `Solo Gemini verificato (ROI: ${geminiStats.roi.toFixed(2)}%)`;
                color = '#f97316';
                bgColor = '#fff7ed';
            }

            indicator.style.background = bgColor;
            indicator.style.display = 'block';
            text.textContent = winner;
            text.style.color = color;
        };

        const updateLearningModel = async () => {
            notify('Modello AI aggiornato!');
        };

        const clearConsole = () => {
            document.getElementById('debug-console').innerHTML = '<div style="color: #10b981;">[SISTEMA] Console pulita</div>';
        };

        const exportData = async () => {
            if (!firebaseReady) return;

            try {
                const snapshot = await firestoreGetDocs(firestoreCollection(db, "ai_predictions"));
                const predictions = snapshot.docs.map(doc => doc.data());

                let csv = 'Data,Strategia,Partita,Lega,Mercato,Tip,Quota,Score,Status\n';

                predictions.forEach(pred => {
                    csv += `${pred.date},${pred.strategy},${pred.match},${pred.league},${pred.market},${pred.tip},${pred.quota.toFixed(2)},${pred.score},${pred.status}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `predictions-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                notify(`${predictions.length} pronostici esportati!`);

            } catch (error) {
                log('error', `‚ùå Errore export: ${error.message}`);
            }
        };

        window.runAnalysis = runAnalysis;
        window.verifyResults = verifyResults;
        window.updateLearningModel = updateLearningModel;
        window.clearConsole = clearConsole;
        window.exportData = exportData;

        document.addEventListener('DOMContentLoaded', () => {
            log('success', 'üéâ Sistema funzionante avviato!');

            document.getElementById('prediction-date').valueAsDate = new Date();

            document.getElementById('today-file').addEventListener('change', (e) => 
                handleUpload(e, 'today', document.getElementById('today-label')));
            document.getElementById('mpetaz-historical').addEventListener('change', (e) => 
                handleUpload(e, 'mpetazHistory', document.getElementById('mpetaz-label')));
            document.getElementById('gemini-historical').addEventListener('change', (e) => 
                handleUpload(e, 'geminiHistory', document.getElementById('gemini-label')));
            document.getElementById('results-file').addEventListener('change', (e) => 
                handleUpload(e, 'results', document.getElementById('results-label')));

            setInterval(() => {
                if (firebaseReady) loadStatistics();
            }, 60000);
        });

        log('info', 'üöÄ Inizializzazione sistema...');
        initFirebase();
    </script>
</body>
</html>