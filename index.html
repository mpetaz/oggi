<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipsterAI - Pronostici</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            backdrop-filter: blur(10px);
        }

        .strategy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .strategy-btn:active {
            transform: scale(0.95);
        }

        .strategy-btn.magic-ai {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
            border: 2px solid #fbbf24;
        }

        .strategy-info {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-info:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .match-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            transition: all 0.3s ease;
        }

        .match-card:active {
            transform: translateY(2px);
        }

        .score-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .flag-btn {
            transition: all 0.2s ease;
        }

        .flag-btn.flagged {
            color: #f59e0b !important;
            transform: scale(1.2);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>

<body class="text-white">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-white text-2xl font-bold mb-4 animate-pulse">TipsterAI</div>
            <div class="text-blue-300 text-sm">Caricamento...</div>
        </div>
    </div>

    <!-- Login Screen (hidden after login) -->
    <div id="login-container"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-40 px-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-gray-800">
            <h2 class="text-2xl font-bold mb-6 text-center">Accedi a TipsterAI</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" required
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" required
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:opacity-90">
                    Accedi
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <!-- Top Bar -->
        <div class="bg-gradient-to-r from-purple-700 to-blue-700 shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="TipsterAI" class="h-10 w-10 rounded-lg">
                    <h1 class="text-2xl font-black">TipsterAI</h1>
                </div>
                <button id="logout-btn" class="text-sm hover:text-yellow-300 transition">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> Esci
                </button>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div id="stats-dashboard" class="container mx-auto px-4 py-6">
            <!-- Riga 1: Box grande totale -->
            <div class="stat-card rounded-xl p-4 text-center mb-3">
                <div class="text-gray-700 text-xs font-semibold mb-1">Pronostici da agosto 2025</div>
                <div id="stat-total" class="text-3xl font-black text-blue-800">-</div>
            </div>

            <!-- Riga 2: 3 box piccoli -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="stat-card rounded-xl p-3 text-center">
                    <div class="text-gray-700 text-[10px] font-semibold mb-1">Pronostici<br>VINTI</div>
                    <div id="stat-wins" class="text-xl font-black text-green-600">-</div>
                </div>
                <div class="stat-card rounded-xl p-3 text-center">
                    <div class="text-gray-700 text-[10px] font-semibold mb-1">Pronostici<br>PERSI</div>
                    <div id="stat-losses" class="text-xl font-black text-red-600">-</div>
                </div>
                <div class="stat-card rounded-xl p-3 text-center">
                    <div class="text-gray-700 text-[10px] font-semibold mb-1">WINRATE</div>
                    <div id="stat-winrate" class="text-xl font-black text-green-600">-</div>
                </div>
            </div>

            <div class="stat-card rounded-lg px-4 py-2 text-center">
                <div class="text-gray-600 text-xs">
                    <i class="fa-solid fa-sparkles mr-1"></i>
                    Aggiornata per nuovi Pronostici: <span id="last-update" class="font-semibold">-</span>
                </div>
            </div>
        </div>

        <!-- Strategies Page -->
        <div id="page-strategies" class="page active container mx-auto px-4 pb-24">
            <h2 class="text-2xl font-bold mb-4 text-center">üìä Seleziona una Strategia</h2>
            <div id="strategies-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Ranking Page -->
        <div id="page-ranking" class="page container mx-auto px-4 pb-24">
            <div class="flex items-center justify-between mb-4">
                <button id="back-to-strategies" class="text-sm hover:text-yellow-300">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Tutte le Strategie
                </button>
                <h2 id="strategy-title" class="text-xl font-bold">-</h2>
            </div>
            <div id="matches-container" class="space-y-4">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- My Matches Page -->
        <div id="page-my-matches" class="page container mx-auto px-4 pb-24">
            <h2 class="text-2xl font-bold mb-4 text-center">‚≠ê Le Mie Partite</h2>
            <div id="my-matches-container" class="space-y-4">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 flex justify-around py-3 z-50">
            <button data-page="strategies" class="nav-btn flex flex-col items-center text-purple-400 transition">
                <i class="fa-solid fa-list text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Strategie</span>
            </button>
            <button data-page="my-matches"
                class="nav-btn flex flex-col items-center text-gray-400 hover:text-yellow-400 transition">
                <i class="fa-solid fa-star text-2xl mb-1"></i>
                <span class="text-xs font-semibold">Mie Partite</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCwAy4QfYlbxj4yBLnho3ZnO2_NaxzbVRQ",
            authDomain: "betmines-pronostici.firebaseapp.com",
            projectId: "betmines-pronostici",
            storageBucket: "betmines-pronostici.firebasestorage.app",
            messagingSenderId: "716119578109",
            appId: "1:716119578109:web:01e8b9dad7b17c91d63594"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let currentUser = null;
        let strategiesData = null;
        let selectedMatches = [];

        // Date formatting
        function formatDateIT(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Auth Check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                await loadData();
            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (e) {
                errorDiv.textContent = 'Email o password errati';
                errorDiv.classList.remove('hidden');
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // Load Data
        async function loadData() {
            try {
                // Load ALL strategies from strategy_results
                const strategiesDoc = await getDoc(doc(db, "system", "strategy_results"));
                if (!strategiesDoc.exists()) {
                    console.error('[Client] strategy_results not found!');
                    return;
                }

                const allStrategies = strategiesDoc.data();
                console.log('[Client] Raw strategies from DB:', Object.keys(allStrategies));

                // Filter: Show ONLY published strategies
                // Presets (all, winrate_80, italia, top_eu, cups, best_05_ht) are ALWAYS shown
                // Custom strategies need to check if they're published

                const presetIds = ['all', 'winrate_80', 'italia', 'top_eu', 'cups', 'best_05_ht'];
                strategiesData = {};

                for (const [stratId, stratData] of Object.entries(allStrategies)) {
                    // Skip if no name or no matches data
                    if (!stratData.name || !stratData.matches) {
                        console.warn(`[Client] Skipping ${stratId} - missing data`);
                        continue;
                    }

                    // Always include presets
                    if (presetIds.includes(stratId)) {
                        strategiesData[stratId] = stratData;
                        continue;
                    }

                    // For custom strategies, check if published
                    // (Custom strategies that are saved via Admin "Salva" button are automatically here)
                    // We include all non-preset strategies found in strategy_results
                    strategiesData[stratId] = stratData;
                }

                console.log('[Client] Filtered published strategies:', Object.keys(strategiesData));

                renderStats();
                renderStrategies();

                // Load user selected matches
                const userMatchesDoc = await getDoc(doc(db, "users", currentUser.uid, "data", "selected_matches"));
                if (userMatchesDoc.exists()) {
                    selectedMatches = userMatchesDoc.data().matches || [];
                    console.log('[Client] Loaded selected matches:', selectedMatches.length);
                    updateMyMatchesCount(); // Initialize badge
                } else {
                    console.log('[Client] No selected matches found');
                }
            } catch (e) {
                console.error('[Client] Critical error loading data:', e);
            }
        }

        // Render Stats
        async function renderStats() {
            try {
                // Query all matches with results
                const matchesQuery = query(collection(db, "matches"), where("risultato", "!=", ""));
                const snapshot = await getDocs(matchesQuery);

                let total = 0;
                let wins = 0;
                let losses = 0;
                let lastDate = '';

                snapshot.forEach(doc => {
                    const m = doc.data();
                    total++;
                    if (m.esito === 'Vinto') wins++;
                    if (m.esito === 'Perso') losses++;
                    if (m.data > lastDate) lastDate = m.data;
                });

                const winrate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;

                // Calculate next day for "new predictions"
                const nextDay = getNextDay(lastDate);

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-wins').textContent = wins;
                document.getElementById('stat-losses').textContent = losses;
                document.getElementById('stat-winrate').textContent = winrate + '%';
                document.getElementById('last-update').textContent = formatDateLong(nextDay);
            } catch (e) {
                console.error('Error calculating stats:', e);
            }
        }

        // Get next day
        function getNextDay(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() + 1);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Format date in Italian long format
        function formatDateLong(dateString) {
            if (!dateString) return '';
            const months = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
                'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
            const [year, month, day] = dateString.split('-');
            return `${parseInt(day)} ${months[parseInt(month) - 1]} ${year}`;
        }

        // Render Strategies
        function renderStrategies() {
            const container = document.getElementById('strategies-grid');
            container.innerHTML = '';

            // Strategy descriptions
            const descriptions = {
                all: 'Tutte le partite pronosticate',
                winrate_80: 'Solo leghe con winrate superiore all\'80%',
                italia: 'Tutte le partite dei campionati Italiani',
                top_eu: 'Principali campionati europei (Premier, Liga, Bundesliga, Ligue 1, Serie A)',
                cups: 'Competizioni europee (Champions, Europa, Conference League)',
                best_05_ht: 'Partite Over 0.5 HT selezionate al 70%+',
                magic_ai: 'La magia dell\'AI con le sue scelte misteriose ü™Ñ'
            };

            Object.keys(strategiesData).forEach(stratId => {
                const strat = strategiesData[stratId];

                // Safety checks
                if (!strat || !strat.name) {
                    console.warn(`[Client] Skipping ${stratId} - invalid data`);
                    return;
                }

                const isMagicAI = stratId.toLowerCase().includes('magic') || (strat.name && strat.name.toLowerCase().includes('magic'));
                const card = document.createElement('button');
                card.className = `strategy-btn ${isMagicAI ? 'magic-ai' : ''} text-white rounded-xl p-6 shadow-lg transform hover:scale-105 transition`;

                const description = descriptions[stratId] || descriptions['magic_ai'] || 'Strategia personalizzata';

                card.innerHTML = `
                    <div class="strategy-info">?</div>
                    <div class="text-3xl mb-2">${getStrategyIcon(stratId, isMagicAI)}</div>
                    <div class="font-bold text-sm mb-1">${strat.name}</div>
                    <div class="text-xs opacity-80">${strat.totalMatches} partite</div>
                `;

                // Info button click
                const infoBtn = card.querySelector('.strategy-info');
                infoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    alert(`${strat.name}\n\n${description}`);
                });

                card.addEventListener('click', () => showRanking(stratId, strat));
                container.appendChild(card);
            });
        }

        // Show Ranking
        function showRanking(stratId, strat) {
            document.getElementById('strategy-title').textContent = strat.name;
            const container = document.getElementById('matches-container');
            container.innerHTML = '';

            if (strat.matches.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-300 py-12">Nessuna partita per questa strategia</div>';
            } else {
                strat.matches.forEach((m, idx) => {
                    const card = createMatchCard(m, idx, stratId);
                    container.appendChild(card);
                });
            }

            showPage('ranking');
        }

        // Create Match Card
        function createMatchCard(match, index, stratId) {
            const matchId = `${match.data}_${match.partita}`;
            const isFlagged = selectedMatches.some(sm => sm.id === matchId);

            const card = document.createElement('div');
            card.className = 'match-card rounded-xl p-5 shadow-lg fade-in';

            const indicationHTML = match.indication ? `
                <div class="${match.indication.bg} ${match.indication.color} px-4 py-2 rounded-xl text-center font-bold text-sm mb-3">
                    ${match.indication.text}
                </div>
            ` : '';

            const betfairHTML = match.betfairBadge ? `
                <div class="text-xs ${match.betfairBadge.color} mt-2">${match.betfairBadge.text}</div>
            ` : '';

            const statsHTML = match.teamStats && match.teamStats.home && match.teamStats.away ? `
                <div class="mt-4 pt-4 border-t border-white/20">
                    <div class="text-xs font-bold mb-2 opacity-80">Statistiche Squadre:</div>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="bg-white/10 p-2 rounded">
                            <div class="font-semibold">üè† Casa</div>
                            <div class="text-lg font-black mt-1">${match.teamStats.home.count}/${match.teamStats.home.total}</div>
                            <div class="text-${match.teamStats.home.color === 'green' ? 'green' : 'yellow'}-400 font-bold">
                                ${match.teamStats.home.percentage}%
                            </div>
                        </div>
                        <div class="bg-white/10 p-2 rounded">
                            <div class="font-semibold">‚úàÔ∏è Trasferta</div>
                            <div class="text-lg font-black mt-1">${match.teamStats.away.count}/${match.teamStats.away.total}</div>
                            <div class="text-${match.teamStats.away.color === 'green' ? 'green' : 'yellow'}-400 font-bold">
                                ${match.teamStats.away.percentage}%
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-3xl font-black text-purple-300">#${index + 1}</span>
                    <button class="flag-btn ${isFlagged ? 'flagged' : ''} text-2xl" data-match-id="${matchId}">
                        <i class="fa-${isFlagged ? 'solid' : 'regular'} fa-star"></i>
                    </button>
                    <span class="score-badge text-white px-4 py-2 rounded-full text-xl font-black">${match.score}</span>
                </div>
                <div class="text-2xl font-bold mb-2">${match.partita}</div>
                <div class="text-sm opacity-80 mb-3">${match.lega}</div>
                <div class="flex flex-wrap gap-2 mb-3">
                    <span class="bg-blue-500/30 text-blue-200 px-3 py-1 rounded-full text-sm font-bold">${match.tip}</span>
                    <span class="bg-gray-700 text-white px-3 py-1 rounded-full text-sm font-bold">@${match.quota}</span>
                    ${match.ora ? `<span class="bg-green-500/30 text-green-200 px-3 py-1 rounded-full text-sm">üïê ${match.ora}</span>` : ''}
                </div>
                ${indicationHTML}
                ${betfairHTML}
                ${statsHTML}
            `;

            // Flag button logic
            const flagBtn = card.querySelector('.flag-btn');
            flagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFlag(matchId, match, stratId, flagBtn);
            });

            return card;
        }

        // Toggle Flag
        async function toggleFlag(matchId, match, stratId, btn) {
            const index = selectedMatches.findIndex(sm => sm.id === matchId);

            if (index >= 0) {
                // Remove
                selectedMatches.splice(index, 1);
                btn.classList.remove('flagged');
                btn.innerHTML = '<i class="fa-regular fa-star"></i>';
            } else {
                // Add
                selectedMatches.push({
                    id: matchId,
                    strategy: strategiesData[stratId].name,
                    ...match
                });
                btn.classList.add('flagged');
                btn.innerHTML = '<i class="fa-solid fa-star"></i>';
            }

            // Save to Firebase
            try {
                await setDoc(doc(db, "users", currentUser.uid, "data", "selected_matches"), {
                    matches: selectedMatches,
                    updated: Date.now()
                });
            } catch (e) {
                console.error('Error saving selection:', e);
            }

            // Update My Matches count
            updateMyMatchesCount();
        }

        // Show My Matches
        function showMyMatches() {
            console.log('[Client] showMyMatches called, selectedMatches:', selectedMatches.length);
            const container = document.getElementById('my-matches-container');
            container.innerHTML = '';

            if (selectedMatches.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-300 py-12">Nessuna partita selezionata</div>';
                console.log('[Client] No matches to show');
            } else {
                console.log('[Client] Rendering', selectedMatches.length, 'matches');
                selectedMatches.forEach((m, idx) => {
                    try {
                        const card = createMatchCard(m, idx, null);
                        // Remove flag button safely
                        const flagBtn = card.querySelector('.flag-btn');
                        if (flagBtn) flagBtn.remove();
                        container.appendChild(card);
                    } catch (e) {
                        console.error('[Client] Error creating match card:', e, m);
                    }
                });
            }
            // DON'T call showPage here - it's already called by the navigation button!
        }

        // Update My Matches Count
        function updateMyMatchesCount() {
            const navBtn = document.querySelector('[data-page="my-matches"]');
            const countBadge = navBtn.querySelector('.count-badge');

            if (selectedMatches.length > 0) {
                if (!countBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'count-badge absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold';
                    badge.textContent = selectedMatches.length;
                    navBtn.style.position = 'relative';
                    navBtn.appendChild(badge);
                } else {
                    countBadge.textContent = selectedMatches.length;
                }
            } else if (countBadge) {
                countBadge.remove();
            }
        }

        // Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            if (pageName === 'strategies') {
                document.getElementById('page-strategies').classList.add('active');
            } else if (pageName === 'ranking') {
                document.getElementById('page-ranking').classList.add('active');
            } else if (pageName === 'my-matches') {
                showMyMatches();
                document.getElementById('page-my-matches').classList.add('active');
            }

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.page === pageName) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-purple-400');
                } else {
                    btn.classList.remove('text-purple-400');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        // Event Listeners
        document.getElementById('back-to-strategies').addEventListener('click', () => showPage('strategies'));

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => showPage(btn.dataset.page));
        });

        // Strategy Icons
        function getStrategyIcon(stratId, isMagicAI = false) {
            if (isMagicAI) return 'ü™Ñ';

            const icons = {
                all: 'üìä',
                winrate_80: 'üî•',
                italia: 'üáÆüáπ',
                top_eu: 'üåç',
                cups: 'üèÜ',
                best_05_ht: '‚ö°'
            };
            return icons[stratId] || 'üéØ';
        }
    </script>
</body>

</html>